<?php

namespace Tests;

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    /**
     * @test
     * RED Test: Asserts that credentials are loaded from environment variables.
     * FAILS on vulnerable code (no getenv/env usage).
     * PASSES on secure code (uses getenv or $_ENV).
     */
    public function testCredentialsLoadedFromEnvironmentVariables(): void
    {
        $sourceFile = __DIR__ . '/../src/Repository/UserRepository.php';
        $this->assertFileExists($sourceFile, 'Source file must exist');
        
        $sourceCode = file_get_contents($sourceFile);
        
        // Secure code should reference environment variable loading functions
        // This pattern will NOT match in vulnerable code with hardcoded literals
        $this->assertMatchesRegularExpression(
            '/\bgetenv\s*\(|\\$_ENV\s*\[|\\$_SERVER\s*\[/',
            $sourceCode,
            'FAIL: No environment variable usage found. Credentials must be loaded from environment variables (getenv, $_ENV, $_SERVER), not hardcoded as literals.'
        );
    }
}