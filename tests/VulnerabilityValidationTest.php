<?php

namespace Tests;

use PHPUnit\Framework\TestCase;
use ReflectionClass;
use ReflectionMethod;

class VulnerabilityValidationTest extends TestCase
{
    /**
     * @test
     * RED Test: Verifies credentials are NOT hardcoded by asserting environment variable usage
     * This FAILS on vulnerable code (no getenv/env calls) and PASSES after fix (env vars used)
     */
    public function testCredentialsNotHardcodedInUserRepository()
    {
        $reflection = new ReflectionClass(\App\Repository\UserRepository::class);
        $sourceFile = $reflection->getFileName();
        $sourceCode = file_get_contents($sourceFile);
        
        // Extract line 74 area where vulnerability is located
        $lines = explode("\n", $sourceCode);
        $vulnerableLine = $lines[73] ?? ''; // Line 74 (0-indexed)
        $context = implode("\n", array_slice($lines, 60, 30)); // Lines 61-90 for context
        
        // RED TEST: Assert that secure code would use environment variables
        // This will FAIL because vulnerable code has hardcoded credentials
        $hasEnvUsage = (
            stripos($context, 'getenv(') !== false ||
            stripos($context, '$_ENV[') !== false ||
            stripos($context, '$_SERVER[') !== false ||
            stripos($context, 'env(') !== false
        );
        
        $this->assertTrue(
            $hasEnvUsage,
            'VULNERABILITY DETECTED: Credentials appear to be hardcoded at line 74. ' .
            'Secure code should use getenv(), $_ENV, or env() to load credentials from environment. ' .
            'Found: ' . substr($vulnerableLine, 0, 100)
        );
    }
}