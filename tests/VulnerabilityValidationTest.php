<?php

namespace App\Tests;

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    private string $sourceFile = __DIR__ . '/../src/Repository/UserRepository.php';

    public function testCredentialsLoadedFromEnvironment(): void
    {
        $this->assertFileExists($this->sourceFile, 'Source file must exist');
        
        $source = file_get_contents($this->sourceFile);
        
        // RED TEST: Assert that source uses getenv() or $_ENV for sensitive data
        // This will FAIL on vulnerable code that has hardcoded credentials instead
        $securePatterns = [
            'getenv(',
            '$_ENV[',
            '$_SERVER[',
        ];
        
        $foundSecurePattern = false;
        foreach ($securePatterns as $pattern) {
            if (stripos($source, $pattern) !== false) {
                $foundSecurePattern = true;
                break;
            }
        }
        
        $this->assertTrue(
            $foundSecurePattern,
            'Credentials must be loaded from environment variables (getenv, $_ENV, $_SERVER), not hardcoded in source'
        );
        
        // Additional check: if we find literal credential assignments, that's a failure
        $this->assertDoesNotMatchRegularExpression(
            '/\$(password|apiKey|secret|token|key)\s*=\s*["\'][^$][^"\']*["\']/',
            $source,
            'Found hardcoded credential assignment. Use environment variables instead.'
        );
    }
}