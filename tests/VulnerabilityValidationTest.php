<?php

namespace Tests;

use PHPUnit\Framework\TestCase;
use ReflectionClass;
use ReflectionMethod;

class VulnerabilityValidationTest extends TestCase
{
    /**
     * @test
     * RED test: Asserts credentials should come from environment variables.
     * FAILS on vulnerable code (hardcoded secrets), PASSES after fix.
     */
    public function testCredentialsShouldNotBeHardcoded(): void
    {
        $sourceFile = getcwd() . '/src/Repository/UserRepository.php';
        $this->assertFileExists($sourceFile, 'Source file must exist');
        
        $sourceCode = file_get_contents($sourceFile);
        
        // Patterns that indicate hardcoded credentials (common PHP patterns)
        $hardcodedPatterns = [
            '/["\']password["\']\s*[=:>]\s*["\'][^"\']{3,}["\']/',
            '/["\']apiKey["\']\s*[=:>]\s*["\'][^"\']{10,}["\']/',
            '/["\']api_key["\']\s*[=:>]\s*["\'][^"\']{10,}["\']/',
            '/["\']secret["\']\s*[=:>]\s*["\'][^"\']{10,}["\']/',
            '/["\']token["\']\s*[=:>]\s*["\'][^"\']{10,}["\']/',
            '/new\s+PDO\(["\'][^"\']*:[^"\']*["\'],\s*["\'][^"\']+["\'],\s*["\'][^"\']+["\']/',
            '/\$password\s*=\s*["\'][^"\']{3,}["\']/',
            '/\$apiKey\s*=\s*["\'][^"\']{10,}["\']/',
        ];
        
        foreach ($hardcodedPatterns as $pattern) {
            if (preg_match($pattern, $sourceCode, $matches)) {
                $this->fail(
                    "Hardcoded credential detected in source code. " .
                    "Credentials must use environment variables (getenv, \$_ENV). " .
                    "Found: " . substr($matches[0], 0, 50) . "..."
                );
            }
        }
        
        // Assert: Secure code should use environment variable functions
        $usesEnvironmentVars = (
            stripos($sourceCode, 'getenv(') !== false ||
            stripos($sourceCode, '$_ENV[') !== false ||
            stripos($sourceCode, '$_SERVER[') !== false
        );
        
        $this->assertTrue(
            $usesEnvironmentVars,
            'Credentials should be loaded from environment variables (getenv, $_ENV, $_SERVER), ' .
            'not hardcoded in source. This is a security requirement per CWE-798.'
        );
    }
}