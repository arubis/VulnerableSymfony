<?php

namespace Tests;

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    private string $sourceFile;
    private string $sourceCode;

    protected function setUp(): void
    {
        $this->sourceFile = __DIR__ . '/../src/Repository/UserRepository.php';
        $this->sourceCode = file_get_contents($this->sourceFile);
    }

    public function testCredentialsLoadedFromEnvironmentVariables(): void
    {
        // RED TEST: Assert that secure credential loading patterns exist
        // This FAILS on vulnerable code because it doesn't use getenv() or $_ENV
        
        $hasGetEnv = preg_match('/getenv\s*\(/', $this->sourceCode);
        $hasEnvArray = preg_match('/\$_ENV\s*\[/', $this->sourceCode);
        $hasEnvSuperglobal = preg_match('/\$_SERVER\s*\[/', $this->sourceCode);
        
        $usesSecureCredentialLoading = $hasGetEnv || $hasEnvArray || $hasEnvSuperglobal;
        
        $this->assertTrue(
            $usesSecureCredentialLoading,
            'Credentials must be loaded from environment variables, not hardcoded. ' .
            'Expected getenv(), $_ENV, or $_SERVER usage in ' . $this->sourceFile
        );
    }

    public function testNoHardcodedPasswordStrings(): void
    {
        // RED TEST: Assert hardcoded password patterns are NOT present
        // This FAILS because vulnerable code contains literal password strings
        
        $hasHardcodedPassword = preg_match(
            '/(password|passwd|pwd)\s*[=:]\s*["\'][^"\']{6,}["\']/',
            $this->sourceCode
        );
        
        $this->assertFalse(
            $hasHardcodedPassword,
            'Found hardcoded password pattern in source code. ' .
            'Passwords must be loaded from environment variables.'
        );
    }

    public function testNoHardcodedApiKeys(): void
    {
        // RED TEST: Assert hardcoded API key patterns are NOT present
        // This FAILS because vulnerable code contains literal API keys
        
        $hasHardcodedApiKey = preg_match(
            '/(api[_-]?key|apikey|api[_-]?secret|token)\s*[=:]\s*["\'][a-zA-Z0-9]{20,}["\']/',
            $this->sourceCode,
            $matches
        );
        
        $this->assertFalse(
            $hasHardcodedApiKey,
            'Found hardcoded API key or token in source code. ' .
            'API keys must be loaded from secure configuration.'
        );
    }
}