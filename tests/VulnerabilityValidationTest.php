<?php

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    public function testCredentialsShouldNotBeHardcodedInClass()
    {
        $targetFile = __DIR__ . '/../src/Repository/UserRepository.php';
        
        $this->assertFileExists($targetFile, 'Target file must exist');
        
        require_once $targetFile;
        
        $reflectionClass = new ReflectionClass('App\Repository\UserRepository');
        
        $constants = $reflectionClass->getConstants();
        $properties = $reflectionClass->getProperties();
        
        $suspiciousPatterns = [
            '/password\s*=\s*["\'][^"\']+["\']/i',
            '/api[_-]?key\s*=\s*["\'][^"\']+["\']/i',
            '/secret\s*=\s*["\'][^"\']+["\']/i',
            '/token\s*=\s*["\'][^"\']+["\']/i',
            '/db[_-]?pass(word)?\s*=\s*["\'][^"\']+["\']/i',
        ];
        
        foreach ($constants as $name => $value) {
            if (is_string($value)) {
                foreach ($suspiciousPatterns as $pattern) {
                    $testString = $name . ' = "' . $value . '"';
                    $this->assertDoesNotMatchRegularExpression(
                        $pattern,
                        $testString,
                        "Hardcoded credential detected in constant: {$name}"
                    );
                }
            }
        }
        
        $sourceCode = file_get_contents($targetFile);
        $lines = explode("\n", $sourceCode);
        
        if (isset($lines[73])) {
            $vulnerableLine = $lines[73];
            
            $this->assertStringNotContainsString('$password', $vulnerableLine, 
                'Line 74 should not contain hardcoded password variable');
            $this->assertStringNotContainsString('$apiKey', $vulnerableLine,
                'Line 74 should not contain hardcoded API key variable');
            
            $hasGetenv = preg_match('/getenv\s*\(/', $vulnerableLine);
            $hasEnvAccess = preg_match('/\$_ENV\[|\$_SERVER\[/', $vulnerableLine);
            
            $this->assertTrue($hasGetenv || $hasEnvAccess,
                'Line 74 should use environment variables (getenv or $_ENV/$_SERVER), not hardcoded credentials');
        }
    }
}