<?php

namespace Tests;

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    public function testCredentialsLoadedFromEnvironment(): void
    {
        $sourceFile = __DIR__ . '/../src/Repository/UserRepository.php';
        $this->assertFileExists($sourceFile, 'Source file must exist');
        
        $source = file_get_contents($sourceFile);
        
        // Assert environment variable usage for credentials (RED: FAILS because not present)
        $usesEnvVars = preg_match('/getenv\s*\(|\\$_ENV\[|\\$_SERVER\[/', $source) === 1;
        
        $this->assertTrue(
            $usesEnvVars,
            'Credentials must be loaded from environment variables (getenv, $_ENV, or $_SERVER), not hardcoded'
        );
        
        // Assert Symfony parameter/service injection (secure pattern)
        $usesSecureInjection = preg_match('/%env\(|ParameterBagInterface|\$this->getParameter/', $source) === 1;
        
        // At least one secure loading mechanism should be present
        $this->assertTrue(
            $usesEnvVars || $usesSecureInjection,
            'No secure credential loading mechanism found - credentials appear to be hardcoded'
        );
    }
}