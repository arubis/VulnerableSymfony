<?php

namespace Tests;

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    /**
     * RED Test: Source analysis to verify credentials are externalized.
     * This approach reads the source and checks for hardcoded credential patterns.
     * Source analysis is acceptable for CWE-798 since hardcoded credentials
     * are inherently a source-level issue.
     */
    public function testNoHardcodedSecretsInSource(): void
    {
        $vulnerableFile = getcwd() . '/src/Repository/UserRepository.php';
        $this->assertFileExists($vulnerableFile, 'Source file must exist');
        
        $sourceCode = file_get_contents($vulnerableFile);
        
        // Check for patterns indicating hardcoded credentials
        $vulnerablePatterns = [
            // Direct password assignments: $password = "literal";
            '/\\$(?:password|pwd|pass|secret|key|token|apikey|api_key)\\s*=\\s*["\'][^"\'$]{8,}["\']/',
            
            // Method calls with hardcoded credentials: setPassword("literal")
            '/(?:setPassword|setApiKey|setSecret|setToken|setCredential)\\s*\\(\\s*["\'][^"\'$]{8,}["\']\\s*\\)/',
            
            // Array keys with hardcoded credentials: ['password' => 'literal']
            '/["\'](?:password|api_key|secret|token)["\']\\s*=>\\s*["\'][^"\'$]{8,}["\']/',
            
            // Configuration arrays with credentials
            '/(?:config|credentials|auth)\\s*=\\s*\\[.*["\'](?:password|key|secret)["\']\\s*=>\\s*["\'][^"\'$]+["\']/s',
        ];
        
        $foundVulnerability = false;
        $matchedPattern = '';
        
        foreach ($vulnerablePatterns as $pattern) {
            if (preg_match($pattern, $sourceCode, $matches)) {
                $foundVulnerability = true;
                $matchedPattern = $matches[0];
                break;
            }
        }
        
        // Additionally check that getenv(), $_ENV, or $_SERVER are used for credentials
        $usesEnvironmentVariables = (
            preg_match('/getenv\\s*\\(["\'](?:.*(?:PASSWORD|KEY|SECRET|TOKEN))/', $sourceCode) ||
            preg_match('/\\$_ENV\\[["\'](?:.*(?:PASSWORD|KEY|SECRET|TOKEN))/', $sourceCode) ||
            preg_match('/\\$_SERVER\\[["\'](?:.*(?:PASSWORD|KEY|SECRET|TOKEN))/', $sourceCode)
        );
        
        // RED assertion: FAILS if hardcoded credentials found OR environment variables NOT used
        $this->assertFalse(
            $foundVulnerability,
            sprintf(
                'VULNERABILITY CWE-798: Hardcoded credentials detected in source code. ' .
                'Matched pattern: %s. Credentials must be loaded from environment variables (getenv, $_ENV, $_SERVER).',
                substr($matchedPattern, 0, 100)
            )
        );
        
        // Secondary assertion: secure code SHOULD use environment variables
        $this->assertTrue(
            $usesEnvironmentVariables,
            'SECURITY BEST PRACTICE VIOLATION: Credentials should be loaded from environment variables. ' .
            'No usage of getenv(), $_ENV, or $_SERVER detected for credential management.'
        );
    }
}