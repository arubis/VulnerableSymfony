<?php

namespace Tests;

use PHPUnit\Framework\TestCase;
use ReflectionClass;
use ReflectionClassConstant;

class VulnerabilityValidationTest extends TestCase
{
    public function testNoHardcodedSecretsInClassDefinition()
    {
        // RED TEST: Check class constants and properties for hardcoded secrets
        // FAILS on vulnerable code with hardcoded credentials
        
        $targetClass = \App\Repository\UserRepository::class;
        
        // Source analysis fallback â€” using reflection to inspect class structure
        // because full behavioral testing requires database setup
        $reflection = new ReflectionClass($targetClass);
        
        // Check class constants
        $constants = $reflection->getConstants();
        foreach ($constants as $name => $value) {
            if (is_string($value) && strlen($value) > 5) {
                $isCredentialName = preg_match('/password|secret|key|token/i', $name);
                $looksLikeSecret = preg_match('/^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};:,.<>?\/\\\\]{8,}$/', $value);
                
                // RED: This FAILS if a constant with credential-like name has a literal value
                $this->assertFalse(
                    $isCredentialName && $looksLikeSecret,
                    "VULNERABILITY: Class constant '{$name}' contains hardcoded credential value. Use environment variables instead."
                );
            }
        }
        
        // Check for hardcoded credentials in source around line 74
        $sourceFile = $reflection->getFileName();
        $sourceLines = file($sourceFile);
        
        // Focus on the vulnerable line and surrounding context
        $startLine = max(0, 74 - 10);
        $endLine = min(count($sourceLines), 74 + 10);
        $contextLines = array_slice($sourceLines, $startLine, $endLine - $startLine);
        $context = implode('', $contextLines);
        
        // Check for hardcoded password patterns in the vulnerable area
        $hasHardcodedPassword = preg_match(
            '/setPassword\\s*\\(\\s*["\'][^getenv\\$_ENV][^"\']{3,}["\']\\s*\\)|\\$password\\s*=\\s*["\'][^"\']{6,}["\']/',
            $context
        );
        
        // RED: FAILS when hardcoded password exists in the vulnerable area
        $this->assertFalse(
            $hasHardcodedPassword,
            'VULNERABILITY: Hardcoded password found near line 74 in UserRepository. Passwords must never be hardcoded in source code (CWE-798).'
        );
    }
}