<?php

namespace Tests;

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    public function testLine74HasNoHardcodedCredentials(): void
    {
        $vulnerableFile = getcwd() . '/src/Repository/UserRepository.php';
        
        $this->assertFileExists($vulnerableFile);
        
        $lines = file($vulnerableFile);
        
        $this->assertGreaterThanOrEqual(74, count($lines), 'File must have at least 74 lines');
        
        $targetLineIndex = 73;
        $contextStart = max(0, $targetLineIndex - 5);
        $contextEnd = min(count($lines), $targetLineIndex + 6);
        
        $contextCode = '';
        for ($i = $contextStart; $i < $contextEnd; $i++) {
            $contextCode .= $lines[$i];
        }
        
        $hasHardcodedCredential = (
            preg_match('/["\'][a-zA-Z0-9_\-]{16,}["\']/', $contextCode) ||
            preg_match('/password\s*=\s*["\']/', $contextCode) ||
            preg_match('/api[_\-]?key\s*=\s*["\']/', $contextCode) ||
            preg_match('/secret\s*=\s*["\']/', $contextCode) ||
            preg_match('/token\s*=\s*["\']/', $contextCode)
        );
        
        $usesSecureRetrieval = (
            preg_match('/getenv\s*\(/', $contextCode) ||
            preg_match('/\$_ENV\[/', $contextCode) ||
            preg_match('/getParameter\s*\(/', $contextCode)
        );
        
        $this->assertTrue(
            !$hasHardcodedCredential || $usesSecureRetrieval,
            'SECURE CODE at line 74 should NOT contain hardcoded credentials. ' .
            'Found literal credential pattern near line 74. ' .
            'Credentials must be retrieved from environment variables or secure configuration using getenv() or similar.'
        );
    }
}