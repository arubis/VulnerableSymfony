<?php

namespace Tests;

use PHPUnit\Framework\TestCase;

class VulnerabilityValidationTest extends TestCase
{
    public function testNoHardcodedCredentialsInSourceCode()
    {
        $sourceFile = __DIR__ . '/../src/Repository/UserRepository.php';
        $this->assertFileExists($sourceFile, 'Source file should exist');
        
        $sourceCode = file_get_contents($sourceFile);
        
        // RED TEST: Assert no hardcoded passwords/secrets (quoted strings that look like credentials)
        // This will FAIL on vulnerable code because hardcoded secrets ARE present
        $hardcodedPatterns = [
            '/["\'][\w]{20,}["\']\s*;/',  // Long alphanumeric strings (API keys)
            '/password\s*=\s*["\'][^"\']+["\']/',  // password = "literal"
            '/api[_-]?key\s*=\s*["\'][^"\']+["\']/',  // apiKey = "literal"
            '/token\s*=\s*["\'][^"\']+["\']/',  // token = "literal"
            '/secret\s*=\s*["\'][^"\']+["\']/',  // secret = "literal"
        ];
        
        foreach ($hardcodedPatterns as $pattern) {
            $this->assertDoesNotMatchRegularExpression(
                $pattern,
                $sourceCode,
                'Source code should NOT contain hardcoded credentials matching pattern: ' . $pattern
            );
        }
    }
}