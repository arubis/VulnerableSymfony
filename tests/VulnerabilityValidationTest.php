<?php

namespace App\Tests;

use PHPUnit\Framework\TestCase;
use ReflectionClass;
use ReflectionFunction;

class VulnerabilityValidationTest extends TestCase
{
    public function testApplicationDoesNotCallWeakHashFunctions(): void
    {
        $vulnerableFile = __DIR__ . '/../src/Controller/AdminController.php';
        
        if (!file_exists($vulnerableFile)) {
            $this->markTestSkipped('AdminController.php not found');
        }
        
        $capturedFunctions = [];
        $originalMd5 = null;
        $originalSha1 = null;
        
        $testPassword = 'userPassword123';
        
        if (function_exists('runkit7_function_rename')) {
            runkit7_function_rename('md5', 'original_md5');
            runkit7_function_rename('sha1', 'original_sha1');
            
            runkit7_function_add('md5', '$str', 'global $capturedFunctions; $capturedFunctions[] = "md5"; return hash("md5", $str);');
            runkit7_function_add('sha1', '$str', 'global $capturedFunctions; $capturedFunctions[] = "sha1"; return hash("sha1", $str);');
        }
        
        try {
            require_once $vulnerableFile;
            
            $testHash = @md5($testPassword);
            if (strlen($testHash) === 32 && ctype_xdigit($testHash)) {
                $capturedFunctions[] = 'md5';
            }
            
            $testHash2 = @sha1($testPassword);
            if (strlen($testHash2) === 40 && ctype_xdigit($testHash2)) {
                $capturedFunctions[] = 'sha1';
            }
            
        } finally {
            if (function_exists('runkit7_function_rename')) {
                runkit7_function_remove('md5');
                runkit7_function_remove('sha1');
                runkit7_function_rename('original_md5', 'md5');
                runkit7_function_rename('original_sha1', 'sha1');
            }
        }
        
        $this->assertEmpty(
            $capturedFunctions,
            'Application should not use weak cryptographic functions (md5, sha1) for passwords. Use password_hash() or Symfony PasswordHasher instead.'
        );
    }
}